<div data-test="CONSULTA-ACTIVA" style="background:#1d4ed8;color:white;padding:6px;border-radius:8px;margin-bottom:8px">
  Estoy en <b>consultation-room.component.html</b>
</div>

<div class="container space-y-4">


  <!-- ── FILA SUPERIOR: Transcripción (izq) + IA (der) ── -->
<div class="row-top">
<!-- Transcripción (izquierda, 2/3) -->
<section class="card">
  <!-- Header -->
  <div class="flex items-center justify-between gap-2 mb-2">
    <h2 class="font-semibold truncate">Transcripción</h2>

    <!-- Toolbar -->
    <div class="flex items-center flex-wrap gap-1">
      <!-- Píldora de estado -->
      <span class="listening-pill" [class.is-on]="listening" aria-live="polite">
        <span class="dot"></span>
        {{ listening ? 'Escuchando…' : 'Detenido' }}
      </span>

        <button class="btn btn-primary flex items-center gap-1" (click)="startMic()">
          <lucide-icon name="mic" class="w-4 h-4"></lucide-icon>
          Iniciar
        </button>

        <button class="btn btn-ghost flex items-center gap-1" (click)="stopMic()">
          <lucide-icon name="pause" class="w-4 h-4"></lucide-icon>
          Pausar
        </button>

        <button class="btn btn-ghost flex items-center gap-1" (click)="clearText()">
          <lucide-icon name="trash-2" class="w-4 h-4"></lucide-icon>
          Limpiar
        </button>

        <button class="btn btn-ghost flex items-center gap-1" (click)="downloadTxt()">
          <lucide-icon name="file-text" class="w-4 h-4"></lucide-icon>
          Exportar TXT
        </button>

        <button class="btn btn-primary flex items-center gap-1" (click)="exportPdf()">
          <lucide-icon name="file" class="w-4 h-4"></lucide-icon>
          Exportar PDF
        </button>

        <button class="btn btn-accent flex items-center gap-1 text-sm" (click)="fileInput.click()" [disabled]="uploading">
          <lucide-icon *ngIf="!uploading" name="upload" class="w-3 h-3"></lucide-icon>
          <span *ngIf="uploading" class="flex gap-0.5">
            <span class="w-1 h-1 bg-current rounded-full animate-bounce"></span>
            <span class="w-1 h-1 bg-current rounded-full animate-bounce" style="animation-delay: 100ms"></span>
            <span class="w-1 h-1 bg-current rounded-full animate-bounce" style="animation-delay: 200ms"></span>
          </span>
          {{ uploading ? 'Procesando...' : 'Cargar Doc' }}
        </button>
        <input #fileInput type="file" hidden accept="image/*,application/pdf" (change)="onFileSelected($event)" />

    </div>
  </div>

  <!-- Barra VAD -->
  <div class="vad-bar" title="Nivel de voz">
    <div class="fill" [style.width.%]="(level*100)"></div>
  </div>

  <!-- Caja de transcripción -->
  <label class="trans-label">Texto capturado</label>
    <div class="trans-shell">
      <textarea
        class="tw-textarea trans-area"
        readonly
        aria-label="Transcripción"
        [value]="(partialText ? (partialText + '\n') : '') + (finalText || '')">
      </textarea>
    </div>
</section>



  <!-- Columna derecha (1/3): IA apilada -->
  <!-- Sidebar IA (1/3) -->
  <aside class="aside-ia self-stretch">

    <!-- Panel de Asistente IA (TODO integrado dentro) -->
    <section class="card flex-1 overflow-hidden">
      <ai-stream-panel></ai-stream-panel>
    </section>
  </aside>
</div>

  <!-- ─────────────────────────────────────────────────────────────────────────── -->

  <!-- ── FORMULARIO CON TABS ────────────────────────────────────────────── -->
<div class="tabs-container">
  <!-- Barra de Tabs -->
  <div class="tabs-header">
    <button
      *ngFor="let tab of tabs"
      type="button"
      class="tab-button"
      [class.active]="activeTab === tab.id"
      [class.has-data]="getCompletedFieldsCount(tab.id) > 0"
      (click)="setActiveTab(tab.id)">
      <span class="tab-icon">{{ tab.icon }}</span>
      <span class="tab-label">{{ tab.label }}</span>
      <span class="tab-badge">
        <ng-container *ngIf="tab.id === 'diagnosticos' || tab.id === 'tratamientos'; else normalCount">
          {{ getCompletedFieldsCount(tab.id) }} {{ tab.id === 'diagnosticos' ? 'diagnósticos' : 'tratamientos' }}
        </ng-container>
        <ng-template #normalCount>
          {{ getCompletedFieldsCount(tab.id) }}/{{ getTotalFieldsCount(tab.id) }}
        </ng-template>
      </span>
    </button>
  </div>

  <!-- Contenido de Tabs -->
  <form [formGroup]="hcForm" class="tab-content">

  <!-- Tab: Afiliación -->
  <fieldset *ngIf="activeTab === 'afiliacion'" formGroupName="afiliacion" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>📋 Afiliación</b></legend>
    <div class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <label>Nombre
        <input class="tw-input" formControlName="nombreCompleto" />
      </label>

      <div formGroupName="edad" class="grid grid-cols-2 gap-2">
        <label>Edad (años)
          <input class="tw-input" type="number" formControlName="anios" />
        </label>
        <label>Edad (meses)
          <input class="tw-input" type="number" formControlName="meses" />
        </label>
      </div>

      <label>Sexo
        <select class="tw-select" formControlName="sexo">
          <option value="">-</option>
          <option>masculino</option><option>femenino</option>
        </select>
      </label>

      <label>DNI
        <input class="tw-input" formControlName="dni" />
      </label>

      <label>Grupo
        <input class="tw-input" formControlName="grupoSangre" />
      </label>

      <label>Fecha/Hora
        <input class="tw-input" formControlName="fechaHora" />
      </label>

      <label>Seguro
        <input class="tw-input" formControlName="seguro" />
      </label>

      <label>Tipo consulta
        <input class="tw-input" formControlName="tipoConsulta" />
      </label>

      <label>Nº Seguro
        <input class="tw-input" formControlName="numeroSeguro" />
      </label>

      <label class="md:col-span-2">Motivo de consulta
        <textarea class="tw-textarea" formControlName="motivoConsulta" rows="2"></textarea>
      </label>
    </div>
  </fieldset>

  <!-- Tab: Anamnesis -->
  <fieldset *ngIf="activeTab === 'anamnesis'" formGroupName="anamnesis" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>🩺 Anamnesis</b></legend>

    <label>Tiempo de enfermedad
      <input class="tw-input" formControlName="tiempoEnfermedad" />
    </label>

    <div>
      <label>Síntomas principales</label>
      <div formArrayName="sintomasPrincipales" class="flex flex-wrap gap-2 mt-1">
        <span class="badge" *ngFor="let s of hcForm.get('anamnesis.sintomasPrincipales')!.value">{{ s }}</span>
      </div>
    </div>

    <label>Relato
      <textarea class="tw-textarea" formControlName="relato" rows="2"></textarea>
    </label>

    <div formGroupName="funcionesBiologicas" class="grid grid-cols-2 md:grid-cols-5 gap-2">
      <label>Apetito <input class="tw-input" formControlName="apetito" /></label>
      <label>Sed <input class="tw-input" formControlName="sed" /></label>
      <label>Orina <input class="tw-input" formControlName="orina" /></label>
      <label>Deposiciones <input class="tw-input" formControlName="deposiciones" /></label>
      <label>Sueño <input class="tw-input" formControlName="sueno" /></label>
    </div>
  </fieldset>

  <!-- Tab: Examen Clínico -->
  <fieldset *ngIf="activeTab === 'examenClinico'" formGroupName="examenClinico" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>💓 Examen Clínico</b></legend>

    <div formGroupName="signosVitales" class="grid grid-cols-1 md:grid-cols-2 gap-3">
      <label>PA <input class="tw-input" formControlName="PA" placeholder="120/80" /></label>
      <label>FC <input class="tw-input" type="number" formControlName="FC" /></label>
      <label>FR <input class="tw-input" type="number" formControlName="FR" /></label>
      <label>Temp <input class="tw-input" type="number" formControlName="temperatura" /></label>
      <label>SpO2 <input class="tw-input" type="number" formControlName="SpO2" /></label>
      <label>IMC <input class="tw-input" type="number" formControlName="IMC" /></label>
    </div>

    <label>Estado general
      <input class="tw-input" formControlName="estadoGeneral" />
    </label>

    <label>Descripción general
      <textarea class="tw-textarea" formControlName="descripcionGeneral" rows="2"></textarea>
    </label>
  </fieldset>

  <!-- Tab: Diagnósticos -->
  <fieldset *ngIf="activeTab === 'diagnosticos'" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>🏷️ Diagnósticos</b></legend>
    <div formArrayName="diagnosticos" class="grid gap-2">
      <div *ngFor="let dg of dxArr.controls; let i = index" [formGroupName]="i"
           class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <label>Nombre <input class="tw-input" formControlName="nombre" /></label>
        <label>Tipo
          <select class="tw-select" formControlName="tipo">
            <option value="">-</option>
            <option>presuntivo</option><option>definitivo</option>
          </select>
        </label>
        <label>CIE-10 <input class="tw-input" formControlName="cie10" /></label>
      </div>
    </div>
  </fieldset>

  <!-- Tab: Tratamientos -->
  <fieldset *ngIf="activeTab === 'tratamientos'" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>💊 Tratamientos</b></legend>
    <div formArrayName="tratamientos" class="grid gap-2">
      <div *ngFor="let tt of ttoArr.controls; let i = index" [formGroupName]="i"
           class="grid grid-cols-1 md:grid-cols-3 gap-2">
        <label>Medicamento <input class="tw-input" formControlName="medicamento" /></label>
        <label>Dosis/Indicación <input class="tw-input" formControlName="dosisIndicacion" /></label>
        <label>GTIN <input class="tw-input" formControlName="gtin" /></label>
      </div>
    </div>
  </fieldset>

  <!-- Tab: Firma -->
  <fieldset *ngIf="activeTab === 'firma'" formGroupName="firma" class="card nm-card nm-card--compact">
    <legend class="card-title"><b>✍️ Firma</b></legend>
    <div class="grid grid-cols-1 md:grid-cols-3 gap-2">
      <label>Médico <input class="tw-input" formControlName="medico" /></label>
      <label>Colegiatura <input class="tw-input" formControlName="colegiatura" /></label>
      <label>Fecha <input class="tw-input" formControlName="fecha" /></label>
    </div>

    <!-- Datos extraídos del documento -->
    <div *ngIf="extractedDataPreview" class="mt-4 border-t pt-4">
      <div class="flex items-center justify-between mb-2">
        <p class="text-sm font-semibold text-gray-700">📄 Datos Extraídos del Documento</p>
        <button type="button" (click)="clearExtractedData()" class="text-xs text-red-600 hover:text-red-800">Limpiar</button>
      </div>
      <div class="bg-gray-50 border border-gray-200 rounded p-3 max-h-48 overflow-y-auto">
        <pre class="text-xs text-gray-700 whitespace-pre-wrap break-words font-mono">{{ extractedDataPreview }}</pre>
      </div>
    </div>
  </fieldset>

  </form>
</div>
<!-- ───────────────────────────────────────────────────────────────────── -->

  <!-- ─────────────────────────────────────────────────────────────────────────── -->

  <!-- Overlay de procesamiento -->
  <div *ngIf="uploading" class="fixed inset-0 bg-black bg-opacity-30 flex items-center justify-center z-50">
    <div class="bg-white rounded-xl shadow-2xl px-8 py-5 max-w-sm mx-4">
      <div class="flex items-center gap-4">
        <div class="flex gap-1">
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 0ms"></span>
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 150ms"></span>
          <span class="w-2 h-2 bg-blue-500 rounded-full animate-bounce" style="animation-delay: 300ms"></span>
        </div>
        <div>
          <p class="font-medium text-gray-900">Procesando documento...</p>
          <p class="text-sm text-gray-500">Extrayendo datos con IA</p>
        </div>
      </div>
    </div>
  </div>

</div>
